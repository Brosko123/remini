"use strict";import _ from"lodash";import got,{RequestError}from"got";import scomp from"./scomp.js";import rd from"./rd.js";import comp from"./comp.js";import copyH from"./copyH.js";const{pick}=_;const validateResponse=res=>{if(res.statusCode>=400||!res.headers["content-type"].startsWith("image")||res.statusCode>=300&&res.headers.location){return rd(req,res)}};export default async function po(req,res){if(req.headers["127.0.0.1","::1"].includes(req.headers["x-forwarded-for"]||req.ip))return rd(req,res);try{const url=req.params.url;const options={headers:{...pick(req.headers,["cookie","dnt","referer","range"]),"user-agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/129.0.0.0 Safari/537.3"},maxRedirects:2,followRedirect:false,throwHttpErrors:false,retry:{limit:2},timeout:{request:1e4},decompress:false};let origin=got.stream(url,options);origin.on("error",()=>req.socket.destroy());origin.on("response",originResponse=>{validateResponse(originResponse);copyHeaders(originResponse,res);res.setHeader("content-encoding","identity");res.setHeader("Access-Control-Allow-Origin","*");res.setHeader("Cross-Origin-Resource-Policy","cross-origin");res.setHeader("Cross-Origin-Embedder-Policy","unsafe-none");req.params.originType=originResponse.headers["content-type"]||"";req.params.originSize=originResponse.headers["content-length"]||"0";if(scomp(req)){return comp(req,res,origin)}else{res.setHeader("x-proxy-bypass",1);for(const headerName of["accept-ranges","content-type","content-length","content-range"]){if(headerName in originResponse.headers)res.setHeader(headerName,originResponse.headers[headerName])}return origin.pipe(res)}})}catch(err){if(error instanceof RequestError){console.log(error);return res.status(503).end("request time out","ascii")}return rd(req,res)}}
